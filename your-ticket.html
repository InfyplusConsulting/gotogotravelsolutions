<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Your GoToGo Ticket</title>
    <link
      rel="shortcut icon"
      href="assets/GoToGo Final Logos/GoToGo Final Logos/G2G Fleet - Inverse Black.png"
      type="image/x-icon"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
      body {
        font-family: "Montserrat", sans-serif;
        margin: 0;
        background: #f5f5f5;
        display: flex;
        justify-content: center;
        align-items: center;
        flex-direction: column;
        min-height: 100vh;
        overflow-x: hidden;
      }

      .ticket-scale-wrapper {
        width: 375px;
        transform-origin: top left;
      }

      .ticket-wrapper {
        width: 375px;
        background: white;
        padding: 20px;
        padding-bottom: 40px;
        box-sizing: border-box;
        border: 1px solid #ccc;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      }

      .download-btn {
        margin: 20px;
        background: #f1c40f;
        border: none;
        padding: 12px 30px;
        font-size: 16px;
        font-weight: bold;
        border-radius: 6px;
        cursor: pointer;
        transition: 0.3s ease;
      }

      .download-btn:hover {
        background: #d4ac0d;
      }

      .ticket-scale-wrapper {
        width: 375px;
        margin: 0 auto;
        transform-origin: top center;
      }

      /* Responsive Scaling */
      @media (max-width: 400px) {
        .ticket-scale-wrapper {
          transform: scale(0.9);
          margin: 0 auto;
        }
      }

      @media (max-width: 360px) {
        .ticket-scale-wrapper {
          transform: scale(0.8);
          margin: 0 auto;
        }
      }

      @media (max-width: 320px) {
        .ticket-scale-wrapper {
          transform: scale(0.75);
          margin: 0 auto;
        }
      }

      .highlight {
        background-color: #eebd36;
        color: #000;
      }

      /* ‚úÖ NEW STYLES FOR THE POPUP MODAL */
      .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8); /* Dark background */
        display: none; /* Hidden by default */
        justify-content: center;
        align-items: center;
        z-index: 10000;
        backdrop-filter: blur(5px);
      }

      .modal-box {
        background: white;
        padding: 30px;
        border-radius: 15px;
        text-align: center;
        max-width: 90%;
        width: 350px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        border: 2px solid #eebd36;
      }

      .modal-icon {
        font-size: 40px;
        margin-bottom: 15px;
      }

      .modal-btn {
        background: #0c52a2;
        color: white;
        padding: 10px 25px;
        border: none;
        border-radius: 50px;
        font-weight: bold;
        margin-top: 20px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
      }
    </style>
  </head>
  <body>
    
    <div id="noBookingModal" class="modal-overlay">
      <div class="modal-box">
        <div class="modal-icon">‚ö†Ô∏è</div>
        <h3 style="margin-top: 0; color: #333;">No Booking Found</h3>
        <p style="font-size: 13px; color: #555; line-height: 1.6; text-align: justify;">
            Please make a booking to see the ticket & details. 
            <br><br>
            <strong>Already booked a ticket?</strong><br>
            Please check if you made the booking from this specific device. If not, please open this link on the <strong>same device</strong> used for booking to download your ticket.
        </p>
        <a href="/" class="modal-btn">Go to Home</a> 
      </div>
    </div>

    <div
      id="globalNotification"
      style="
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: #0c52a2;
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        z-index: 9999;
        display: none;
        font-weight: 500;
        transition: opacity 0.3s ease;
      "
    ></div>

    <script>
      function showToast(message) {
        const toast = document.createElement("div");
        toast.style.cssText = `
      position: fixed; top: 20px; right: 20px;
      background: #0c52a2; color: white;
      padding: 12px 20px; border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
      z-index: 9999;
    `;
        toast.textContent = message;
        document.body.appendChild(toast);
        setTimeout(() => toast.remove(), 4000);
      }
    </script>

    <div id="mainContentWrapper" style="display: flex; flex-direction: column; align-items: center;">
        <button onclick="generatePDF()" class="download-btn">
          Download Ticket
        </button>

        <div class="ticket-scale-wrapper" id="ticket">
          <div class="ticket-wrapper">
            <div
              style="
                display: flex;
                justify-content: space-around;
                align-items: center;
                background: #eebd36;
                padding: 0px;
                gap: 20px;
              "
            >
              <img
                src="./assets/logo.jpg"
                alt="GoToGo Logo"
                style="height: 40px; padding: 4px"
              />
              <div style="font-weight: bold; font-size: 12px">
                SHUTTLE TO AIRPORT
              </div>
            </div>

            <div
              style="
                margin-top: 10px;
                display: flex;
                justify-content: space-between;
              "
            >
              <div>
                <div style="color: #737373; font-size: 12px; font-weight: bold">
                  NAMES OF PASSENGERS
                </div>
                <ul
                  id="passengerList"
                  style="
                    color: #004aad;
                    font-size: 12px;
                    font-weight: bold;
                    margin-left: -40px;
                    list-style: none;
                  "
                ></ul>
              </div>

              <div style="display: flex; align-items: center">
                <div style="color: #737373; font-size: 12px; font-weight: bold">
                  TICKET #
                </div>
                <div
                  class="ticket-number"
                  id="ticket-number"
                  style="
                    border: 2px solid #000;
                    border-radius: 18px;
                    padding: 5px 8px;
                    font-weight: bold;
                    color: #004aad;
                    font-size: 10px;
                  "
                  class="ticket-number"
                >
                  Loading...
                </div>
              </div>
            </div>

            <div
              style="
                margin-top: 10px;
                display: flex;
                justify-content: space-between;
              "
            >
              <div>
                <div style="color: #737373; font-size: 12px; font-weight: bold">
                  SHUTTLE BOARDING TIME
                </div>
                <div
                  style="display: flex; gap: 10px; margin-top: 5px; color: #004aad"
                >
                  <div
                    data-time="06:00 AM"
                    id="boardingTime"
                    class="boarding-box"
                    style="
                      font-weight: bold;
                      text-align: center;
                      border-radius: 50%;
                      border: 2px solid #000;
                      width: 30px;
                      height: 30px;
                      display: flex;
                      flex-direction: column;
                      justify-content: center;
                      align-items: center;
                      padding: 2px;
                      font-size: 12px;
                    "
                  >
                    6<br /><span style="font-size: 10px; font-weight: bold"
                      >Am</span
                    >
                  </div>
                  <div
                    data-time="07:00 AM"
                    id="boardingTime"
                    class="boarding-box"
                    style="
                      font-weight: bold;
                      text-align: center;
                      border-radius: 50%;
                      border: 2px solid #000;
                      width: 30px;
                      height: 30px;
                      display: flex;
                      flex-direction: column;
                      justify-content: center;
                      align-items: center;
                      padding: 2px;
                      font-size: 12px;
                    "
                  >
                    7<br /><span style="font-size: 10px; font-weight: bold"
                      >Am</span
                    >
                  </div>
                  <div
                    data-time="08:00 AM"
                    id="boardingTime"
                    class="boarding-box"
                    style="
                      font-weight: bold;
                      text-align: center;
                      border-radius: 50%;
                      border: 2px solid #000;
                      width: 30px;
                      height: 30px;
                      display: flex;
                      flex-direction: column;
                      justify-content: center;
                      align-items: center;
                      padding: 2px;
                      font-size: 12px;
                    "
                  >
                    8<br /><span style="font-size: 10px; font-weight: bold"
                      >Am</span
                    >
                  </div>
                </div>
              </div>
              <div>
                <div style="color: #737373; font-size: 12px; font-weight: bold">
                  DROP TERMINAL
                </div>
                <div
                  style="display: flex; gap: 5px; margin-top: 5px; color: #004aad"
                >
                  <div
                    data-terminal="(IGI) T1"
                    class="terminal-box"
                    style="
                      font-weight: bold;
                      text-align: center;
                      border-radius: 50%;
                      border: 2px solid #000;
                      width: 30px;
                      height: 30px;
                      display: flex;
                      flex-direction: column;
                      justify-content: center;
                      align-items: center;
                      padding: 2px;
                      font-size: 12px;
                    "
                  >
                    T1
                  </div>
                  <div
                    data-terminal="(IGI) T2"
                    class="terminal-box"
                    style="
                      font-weight: bold;
                      text-align: center;
                      border-radius: 50%;
                      border: 2px solid #000;
                      width: 30px;
                      height: 30px;
                      display: flex;
                      flex-direction: column;
                      justify-content: center;
                      align-items: center;
                      padding: 2px;
                      font-size: 12px;
                    "
                  >
                    T2
                  </div>
                  <div
                    data-terminal="(IGI) T3"
                    class="terminal-box"
                    style="
                      font-weight: bold;
                      text-align: center;
                      border-radius: 50%;
                      border: 2px solid #000;
                      width: 30px;
                      height: 30px;
                      display: flex;
                      flex-direction: column;
                      justify-content: center;
                      align-items: center;
                      padding: 2px;
                      font-size: 12px;
                    "
                  >
                    T3
                  </div>
                </div>
              </div>
            </div>

            <div
              style="
                margin-top: 10px;
                display: flex;
                justify-content: space-between;
                font-size: 12px;
              "
            >
              <div>
                <div style="color: #737373; font-weight: bold">PICKUP DATE</div>
                <div id="pickupDate" style="font-weight: bold; color: #004aad">
                  Loading...
                </div>
              </div>
              <div>
                <div style="color: #737373; font-weight: bold">PAYMENT STATUS</div>
                <div id="paymentStatus" style="font-weight: bold; color: #004aad">No Payment MSG!</div>
              </div>
            </div>

            <div
              style="
                margin-top: 10px;
                display: flex;
                justify-content: space-between;
                font-size: 12px;
              "
            >
              <div>
                <div style="color: #737373; font-weight: bold">PICKUP LOCATION</div>
                <div id="pickupLocation" style="font-weight: bold; color: #004aad">
                  Loading...
                </div>
              </div>
            </div>

            <div
              style="
                border: 3px solid #eebd36;
                padding: 10px;
                margin-top: 10px;
                border-radius: 19px;
              "
            >
              <div
                style="
                  font-weight: bold;
                  font-size: 12px;
                  background: #eebd36;
                  width: 230px;
                  border-radius: 8px;
                  padding: 2px;
                  position: relative;
                  top: -20px;
                  left: 50px;
                "
              >
                Travel Assistance: (+91) 7065 650 650
              </div>
              <div style="font-size: 8px; text-align: justify; margin-top: -10px">
                For
                <span style="font-weight: bold; color: #737373"
                  >International Travel,</span
                >
                please arrive 4 hours before the flight. For
                <span style="font-weight: bold; color: #737373"
                  >Domestic Travel,</span
                >
                please arrive 3 hours before the flight. Please take care of your
                belongings while on board.
              </div>
            </div>

            <div style="margin-top: 10px">
              <h4 style="margin-bottom: 5px; font-size: 12px">
                TERMS & CONDITIONS
              </h4>
              <ul style="font-size: 8px; padding-left: 20px; text-align: justify">
                <li>
                  <strong>Seating Policy:</strong> Seats are not pre-assigned.
                  Seating is strictly on a first-come, first-served basis.
                </li>
                <li>
                  <strong>Departure Timings:</strong> The shuttle will depart
                  strictly as per the scheduled time. There will be no additional
                  waiting. Passengers are requested to arrive at the pickup point
                  well in advance to avoid missing the shuttle.
                </li>
                <li>
                  <strong>No-Show Policy:</strong> In case of a no-show, the booking
                  will be considered fully charged and non-refundable.
                </li>
                <li>
                  <strong>Cancellation & Transfer:</strong> This ticket is
                  non-cancellable, non-transferable, and non-refundable under normal
                  circumstances.
                </li>
                <li>
                  <strong>Exceptions (Force Majeure):</strong> In the event of
                  unforeseen conditions (e.g., natural disasters, strikes, etc.)
                  affecting service operations, alternate arrangements or refunds
                  will be offered based on the situation and feasibility.
                </li>
                <li>
                  <strong>Refund Processing:</strong> If a refund is applicable, it
                  will be processed within 14 working days.
                </li>
                <li>
                  <strong>Service Disclaimer:</strong> GoToGo shall not be held
                  responsible for flight delays, traffic disruptions, or external
                  factors impacting pickup/drop timing.
                </li>
                <li>
                  <strong>Customer Support:</strong> For assistance, please contact
                  our helpline: +91 7065 650 650.
                </li>
              </ul>
            </div>
            <div class="footer-image-container" style="text-align: center">
              <img src="./assets/footer-ticket.png" alt="footer" width="100%" />
            </div>
          </div>
        </div>
    </div>
    <!-- <script>
      // 1. PDF ‡§ú‡§®‡§∞‡•á‡§∂‡§® ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
async function generatePDF() {
  const element = document.getElementById("ticket");
  const canvas = await html2canvas(element, {
    scale: 3,
    useCORS: true,
    scrollY: 0,
  });

  const imgData = canvas.toDataURL("image/jpeg", 1.0);
  const { jsPDF } = window.jspdf;
  const pdf = new jsPDF({
    orientation: "portrait",
    unit: "px",
    format: [canvas.width, canvas.height],
  });

  pdf.addImage(imgData, "JPEG", 0, 0, canvas.width, canvas.height);
  pdf.save("GoToGo-Ticket.pdf");
}

// 2. ‡§≤‡•ã‡§°‡§∞ ‡§î‡§∞ ‡§è‡§∞‡§∞ ‡§∏‡•ç‡§ï‡•ç‡§∞‡•Ä‡§® ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®‡•ç‡§∏
// ‚úÖ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®: ‡§∏‡•ç‡§Æ‡§æ‡§∞‡•ç‡§ü ‡§≤‡•ã‡§°‡§∞ (Airport Theme)
function showFullPageLoader() {
    // 1. Loader HTML Structure
    const loader = document.createElement("div");
    loader.id = "pageLoader";
    loader.style.cssText = `
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: #ffffff; z-index: 20000; display: flex;
        flex-direction: column; align-items: center; justify-content: center;
        font-family: 'Montserrat', sans-serif; text-align: center;
    `;

    // 2. IGI Airport & Travel Facts
    const facts = [
        "Did you know? IGI Airport is the busiest airport in India.",
        "Connecting to secure server... Please wait.",
        "Did you know? Terminal 3 is the 8th largest terminal in the world.",
        "Retrieving your shuttle schedule...",
        "Fun Fact: IGI Airport handles over 70 million passengers annually.",
        "Generating your boarding pass...",
        "Did you know? The airport is named after Indira Gandhi, former PM of India.",
        "Finalizing your pickup details...",
        "Almost there! Just a few more seconds..."
    ];

    // 3. Inner HTML (Spinner + Text + Progress Bar)
    loader.innerHTML = `
        <div style="position: relative; width: 80px; height: 80px; margin-bottom: 30px;">
            <div style="
                width: 100%; height: 100%; border: 8px solid #f3f3f3; 
                border-top: 8px solid #eebd36; border-radius: 50%; 
                animation: spin 1.5s linear infinite;">
            </div>
            <img src="assets/GoToGo Final Logos/GoToGo Final Logos/G2G Fleet - Inverse Black.png" 
                 style="position: absolute; top: 55%; left: 60%; transform: translate(-50%, -50%); width: 80px; opacity: 0.8;" 
                 alt="Logo">
        </div>

        <h2 style="color: #0c52a2; margin-bottom: 10px; font-size: 20px;">Fetching Your Ticket</h2>
        
        <p id="loaderMessage" style="
            font-size: 14px; color: #555; max-width: 400px; 
            min-height: 40px; transition: opacity 0.5s ease-in-out;">
            Establishing secure connection...
        </p>

        <div style="width: 300px; height: 6px; background: #eee; border-radius: 10px; margin-top: 20px; overflow: hidden;">
            <div id="loaderProgress" style="
                width: 5%; height: 100%; background: #eebd36; 
                border-radius: 10px; transition: width 0.5s;">
            </div>
        </div>

        <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
    `;

    document.body.appendChild(loader);

    // 4. Logic: Rotate Messages & Progress Bar
    const msgElement = document.getElementById("loaderMessage");
    const progressElement = document.getElementById("loaderProgress");
    let msgIndex = 0;
    let progress = 5;

    // Message Interval (Har 3.5 second mein message change)
    const msgInterval = setInterval(() => {
        msgElement.style.opacity = 0; // Fade out
        
        setTimeout(() => {
            msgIndex = (msgIndex + 1) % facts.length;
            msgElement.innerText = facts[msgIndex];
            msgElement.style.opacity = 1; // Fade in
        }, 500);

        // Progress bar logic
        if (progress < 90) {
            progress += Math.floor(Math.random() * 15) + 5; 
            if (progress > 90) progress = 90;
            progressElement.style.width = progress + "%";
        }

    }, 3500);

    loader.dataset.intervalId = msgInterval;
    return loader;
}

// ‚úÖ ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®: ‡§≤‡•ã‡§°‡§∞ ‡§π‡§ü‡§æ‡§®‡§æ (Progress Bar Complete ‡§ï‡§∞‡§ï‡•á)
function removeLoader(loader) {
    if (loader) {
        const progressElement = loader.querySelector("#loaderProgress");
        if(progressElement) progressElement.style.width = "100%";
        
        setTimeout(() => {
            clearInterval(loader.dataset.intervalId);
            loader.remove();
        }, 500);
    }
}

function showErrorScreen(title, msg) {
  document.body.innerHTML = `
    <div style="height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; font-family:sans-serif; background:white; position:fixed; top:0; left:0; width:100%; z-index:30000;">
      <img src="./assets/gotogo final logos/g2g fleet.png" alt="GoToGo Logo" style="width:100px; margin-bottom: 20px;" />
        <h1 style="color:#d32f2f;">${title}</h1>
        <p style="padding: 0 20px;">${msg}</p>
        <a href="/" style="margin-top:20px; text-decoration:none; background:#eebd36; color:black; padding:10px 20px; border-radius:50px; font-weight:bold;">Go to Home</a>
    </div>
  `;
}

// 3. ‡§°‡•á‡§ü‡§æ ‡§∞‡•á‡§Ç‡§°‡§∞‡§ø‡§Ç‡§ó ‡§´‡§Ç‡§ï‡•ç‡§∂‡§® (Shared for both DB and LocalStorage)
function renderTicketData(data) {
  // ‡§ü‡§ø‡§ï‡§ü ‡§®‡§Ç‡§¨‡§∞ ‡§î‡§∞ ‡§°‡•á‡§ü
  document.getElementById("ticket-number").innerText = data.ticketNumber || "G2G-UNKNOWN";
  
  const pDate = data.billing ? data.billing.pickupDate : data.pickupDate;
  const formattedDate = new Date(pDate).toLocaleDateString("en-US", {
    year: "numeric", month: "long", day: "numeric"
  });
  document.getElementById("pickupDate").innerText = formattedDate;

  // ‡§≤‡•ã‡§ï‡•á‡§∂‡§® ‡§î‡§∞ ‡§™‡•á‡§Æ‡•á‡§Ç‡§ü
  document.getElementById("pickupLocation").innerText = (data.billing ? data.billing.pickupLocation : data.pickupLocation) || "N/A";
  
  const pStatusDiv = document.getElementById("paymentStatus");
  if (pStatusDiv) {
    const method = data.paymentMethod ? data.paymentMethod.toLowerCase() : (data.paymentStatus === "success" ? "online" : "cash");
    pStatusDiv.innerText = method === "cash" ? "Pay on Arrival" : "Paid Online";
    pStatusDiv.style.color = method === "cash" ? "#e67e22" : "#27ae60";
  }

  // ‡§™‡•à‡§∏‡•á‡§Ç‡§ú‡§∞ ‡§≤‡§ø‡§∏‡•ç‡§ü
  const passengerList = document.getElementById("passengerList");
  if (passengerList) {
    passengerList.innerHTML = "";
    const namesArray = data.travelers ? data.travelers.map(t => t.name) : (data.names || []);
    namesArray.forEach(name => {
      if (name && name.trim()) {
        const li = document.createElement("li");
        li.textContent = name.trim();
        passengerList.appendChild(li);
      }
    });
  }

  // Highlights
  const bTime = data.billing ? data.billing.boardingTime : data.boardingTime;
  const dTerm = data.billing ? data.billing.terminal : data.terminal;

  document.querySelectorAll(".boarding-box").forEach(box => {
    box.classList.toggle("highlight", box.getAttribute("data-time") === bTime);
  });
  document.querySelectorAll(".terminal-box").forEach(box => {
    box.classList.toggle("highlight", box.getAttribute("data-terminal") === dTerm);
  });
}

// 4. ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§≤‡•â‡§ú‡§ø‡§ï (Combined Listener)
document.addEventListener("DOMContentLoaded", async () => {
  const urlParams = new URLSearchParams(window.location.search);
  const ticketId = urlParams.get('ticket');

  if (ticketId) {
    // CASE A: ‡§à‡§Æ‡•á‡§≤ ‡§≤‡§ø‡§Ç‡§ï ‡§∏‡•á ‡§°‡•á‡§ü‡§æ ‡§≤‡§æ‡§ì
    const loader = showFullPageLoader();
    // üõë TESTING BREAKTHROUGH: 5 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§ï‡§æ ‡§°‡§ø‡§≤‡•á (‡§á‡§∏‡•á ‡§ü‡•á‡§∏‡•ç‡§ü ‡§ï‡•á ‡§¨‡§æ‡§¶ ‡§π‡§ü‡§æ ‡§¶‡•á‡§®‡§æ)
        await new Promise(resolve => setTimeout(resolve, 100000)); 

    try {
      const response = await fetch(`http://localhost:5000/api/get-shuttle-ticket/${ticketId}`);
      const data = await response.json();

      if (data.success) {
        const booking = data.booking;
        const today = new Date().setHours(0,0,0,0);
        const tourDate = new Date(booking.billing.pickupDate).setHours(0,0,0,0);

        if (tourDate < today) {
          showErrorScreen("Ticket Expired", `This ticket was valid for ${booking.billing.pickupDate}.`);
        } else {
          renderTicketData(booking);
        }
      } else {
        showErrorScreen("Invalid Ticket", "No such ticket found in our database.");
      }
    } catch (err) {
      showErrorScreen("Connection Error", "Unable to connect to the server.");
    } finally {
      loader.remove();
    }
  } else {
    // CASE B: ‡§≤‡•ã‡§ï‡§≤ ‡§∏‡•ç‡§ü‡•ã‡§∞‡•á‡§ú ‡§ö‡•á‡§ï ‡§ï‡§∞‡•ã
    const localData = JSON.parse(localStorage.getItem("bookingDetails"));
    if (!localData) {
      document.getElementById('mainContentWrapper').style.display = 'none';
      document.getElementById('noBookingModal').style.display = 'flex';
    } else {
      renderTicketData(localData);
    }
  }
});


    </script> -->

    <script>
    // ==========================================
    // üåç GLOBAL VARIABLES
    // ==========================================
    let isGameActive = false;   // ‡§ï‡•ç‡§Ø‡§æ ‡§ó‡•á‡§Æ ‡§ö‡§≤ ‡§∞‡§π‡§æ ‡§π‡•à?
    let isTicketReady = false;  // ‡§ï‡•ç‡§Ø‡§æ ‡§°‡•á‡§ü‡§æ ‡§Ü ‡§ö‡•Å‡§ï‡§æ ‡§π‡•à?
    let loaderRef = null;       // ‡§≤‡•ã‡§°‡§∞ ‡§ï‡§æ ‡§∞‡•á‡§´‡§∞‡•á‡§®‡•ç‡§∏

    // 1. PDF ‡§ú‡§®‡§∞‡•á‡§∂‡§® ‡§´‡§Ç‡§ï‡•ç‡§∂‡§®
    async function generatePDF() {
        const element = document.getElementById("ticket");
        const canvas = await html2canvas(element, { scale: 3, useCORS: true, scrollY: 0 });
        const imgData = canvas.toDataURL("image/jpeg", 1.0);
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({ orientation: "portrait", unit: "px", format: [canvas.width, canvas.height] });
        pdf.addImage(imgData, "JPEG", 0, 0, canvas.width, canvas.height);
        pdf.save("GoToGo-Ticket.pdf");
    }

    // ==========================================
    // ‚úàÔ∏è 1. SMART LOADER (AIRPORT THEME)
    // ==========================================
    function showFullPageLoader() {
        const loader = document.createElement("div");
        loader.id = "pageLoader";
        loader.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #ffffff; z-index: 20000; display: flex;
            flex-direction: column; align-items: center; justify-content: center;
            font-family: 'Montserrat', sans-serif; text-align: center;
        `;

        const facts = [
            "Did you know? IGI Airport is the busiest airport in India.",
            "Connecting to secure server... Please wait.",
            "Did you know? Terminal 3 is the 8th largest terminal in the world.",
            "Retrieving your shuttle schedule...",
            "Fun Fact: IGI Airport handles over 70 million passengers annually.",
            "Generating your boarding pass...",
            "Did you know? The airport is named after Indira Gandhi, former PM of India.",
            "Finalizing your pickup details...",
            "Almost there! Just a few more seconds..."
        ];

        loader.innerHTML = `
            <div style="position: relative; width: 80px; height: 80px; margin-bottom: 30px;">
                <div style="width: 100%; height: 100%; border: 8px solid #f3f3f3; border-top: 8px solid #eebd36; border-radius: 50%; animation: spin 1.5s linear infinite;"></div>
                <img src="assets/GoToGo Final Logos/GoToGo Final Logos/G2G Fleet - Inverse Black.png" style="position: absolute; top: 55%; left: 60%; transform: translate(-50%, -50%); width: 80px; opacity: 0.8;" alt="Logo">
            </div>

            <h2 style="color: #0c52a2; margin-bottom: 10px; font-size: 20px;">Fetching Your Ticket</h2>
            
            <p id="loaderMessage" style="font-size: 14px; color: #555; max-width: 400px; min-height: 40px; transition: opacity 0.5s ease-in-out;">
                Establishing secure connection...
            </p>

            <div style="width: 300px; height: 6px; background: #eee; border-radius: 10px; margin-top: 20px; overflow: hidden;">
                <div id="loaderProgress" style="width: 5%; height: 100%; background: #eebd36; border-radius: 10px; transition: width 0.5s;"></div>
            </div>

            <div style="margin-top: 40px;">
                <p style="font-size: 12px; color: #999; margin-bottom: 10px;">Waiting is boring?</p>
                <button onclick="startGameOverlay()" style="
                    background: #2ecc71; color: white; border: none; padding: 10px 25px; 
                    border-radius: 25px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(46, 204, 113, 0.3);
                    display: flex; align-items: center; gap: 8px; margin: 0 auto; transition: transform 0.2s;">
                    <span>‚úàÔ∏è</span> Play Flappy Plane
                </button>
            </div>

            <style>@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }</style>
        `;

        document.body.appendChild(loader);
        loaderRef = loader;

        // Logic: Rotate Messages
        const msgElement = document.getElementById("loaderMessage");
        const progressElement = document.getElementById("loaderProgress");
        let msgIndex = 0;
        let progress = 5;

        const msgInterval = setInterval(() => {
            msgElement.style.opacity = 0;
            setTimeout(() => {
                msgIndex = (msgIndex + 1) % facts.length;
                msgElement.innerText = facts[msgIndex];
                msgElement.style.opacity = 1;
            }, 500);
            if (progress < 90) {
                progress += Math.floor(Math.random() * 15) + 5;
                if (progress > 90) progress = 90;
                progressElement.style.width = progress + "%";
            }
        }, 3500);

        loader.dataset.intervalId = msgInterval;
        return loader;
    }

    function removeLoader() {
        if (loaderRef) {
            const progressElement = loaderRef.querySelector("#loaderProgress");
            if (progressElement) progressElement.style.width = "100%";
            setTimeout(() => {
                clearInterval(loaderRef.dataset.intervalId);
                loaderRef.remove();
                loaderRef = null;
            }, 500);
        }
    }

    // ==========================================
    // üéÆ 2. FLAPPY PLANE GAME ENGINE
    // ==========================================
    let gameLoopId, gameCanvas, ctx, bird, pipes, score, frame;
    let canvasWidth, canvasHeight;

    function startGameOverlay() {
        isGameActive = true;
        const gameDiv = document.createElement("div");
        gameDiv.id = "gameOverlay";
        gameDiv.style.cssText = `
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #87CEEB; z-index: 21000; font-family: 'Montserrat', sans-serif;
        `;

        gameDiv.innerHTML = `
            <canvas id="gameCanvas" style="display: block; width: 100%; height: 100%;"></canvas>
            <div style="position: absolute; top: 20px; left: 20px;">
                <button onclick="closeGame()" style="background: rgba(0,0,0,0.3); color: white; border: none; padding: 5px 15px; border-radius: 15px; cursor: pointer;">‚úï Close</button>
            </div>
            <div style="position: absolute; top: 20px; width: 100%; text-align: center; pointer-events: none;">
                <div id="gameScore" style="font-size: 50px; color: white; font-weight: bold; text-shadow: 2px 2px 0 #000;">0</div>
            </div>

            <div id="gameTicketReady" style="
                display: none; position: absolute; top: 80px; left: 50%; transform: translateX(-50%);
                background: white; padding: 10px 20px; border-radius: 30px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                animation: slideDown 0.5s ease;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <span style="color: #27ae60; font-weight: bold;">‚úÖ Ticket Ready!</span>
                    <button onclick="closeGame()" style="background: #0c52a2; color: white; border: none; padding: 5px 15px; border-radius: 20px; cursor: pointer; font-weight: bold;">View Now</button>
                </div>
            </div>
            <style>@keyframes slideDown { from { top: -50px; } to { top: 80px; } }</style>
        `;
        document.body.appendChild(gameDiv);
        
        // Check if ticket was already loaded before game started
        if (isTicketReady) {
            document.getElementById("gameTicketReady").style.display = "block";
        }

        initGameLogic();
    }

    function closeGame() {
        isGameActive = false;
        cancelAnimationFrame(gameLoopId);
        const gameDiv = document.getElementById("gameOverlay");
        if (gameDiv) gameDiv.remove();
        
        // If ticket is ready, remove main loader too
        if (isTicketReady) {
            removeLoader();
        }
    }

    function initGameLogic() {
        gameCanvas = document.getElementById("gameCanvas");
        ctx = gameCanvas.getContext("2d");
        gameCanvas.width = window.innerWidth;
        gameCanvas.height = window.innerHeight;
        canvasWidth = gameCanvas.width;
        canvasHeight = gameCanvas.height;

        bird = { x: 50, y: canvasHeight / 2, velocity: 0, gravity: 0.5, jump: -8, radius: 15 };
        pipes = [];
        score = 0;
        frame = 0;

        window.addEventListener("keydown", (e) => { if(e.code === 'Space') jump(); });
        window.addEventListener("touchstart", (e) => { e.preventDefault(); jump(); });
        window.addEventListener("mousedown", jump);
        loop();
    }

    function jump() { bird.velocity = bird.jump; }

    function loop() {
        if (!isGameActive) return;
        ctx.fillStyle = "#87CEEB"; ctx.fillRect(0, 0, canvasWidth, canvasHeight);
        
        // Bird
        bird.velocity += bird.gravity;
        bird.y += bird.velocity;
        ctx.fillStyle = "#f4be30"; ctx.beginPath(); ctx.arc(bird.x, bird.y, bird.radius, 0, Math.PI * 2); ctx.fill();
        ctx.fillStyle = "white"; ctx.fillRect(bird.x - 10, bird.y - 5, 10, 5); // Wing

        if (bird.y + bird.radius >= canvasHeight) resetGame();

        // Pipes
        if (frame % 120 === 0) {
            let gap = 200;
            let topH = Math.random() * (canvasHeight - gap - 100) + 50;
            pipes.push({ x: canvasWidth, top: topH, bottom: topH + gap });
        }

        pipes.forEach((pipe, i) => {
            pipe.x -= 3;
            ctx.fillStyle = "#61b67f"; 
            ctx.fillRect(pipe.x, 0, 50, pipe.top); 
            ctx.fillRect(pipe.x, pipe.bottom, 50, canvasHeight - pipe.bottom);

            if (bird.x + bird.radius > pipe.x && bird.x - bird.radius < pipe.x + 50 && (bird.y - bird.radius < pipe.top || bird.y + bird.radius > pipe.bottom)) {
                resetGame();
            }
            if (pipe.x + 50 < bird.x && !pipe.passed) { score++; pipe.passed = true; document.getElementById("gameScore").innerText = score; }
            if (pipe.x < -50) pipes.splice(i, 1);
        });

        frame++;
        gameLoopId = requestAnimationFrame(loop);
    }

    function resetGame() {
        bird.y = canvasHeight / 2; bird.velocity = 0; pipes = []; score = 0;
    }

    // ==========================================
    // 3. TICKET LOGIC & HANDLERS
    // ==========================================
    
    // When Ticket Data Arrives
    function onTicketLoaded(data, isDB) {
        isTicketReady = true;
        renderTicketData(data); // Render data in background

        // Check Date Expiry
        if (isDB) {
            const today = new Date().setHours(0,0,0,0);
            const tourDate = new Date(data.billing.pickupDate).setHours(0,0,0,0);
            if (tourDate < today) {
                if(isGameActive) closeGame();
                removeLoader();
                showErrorScreen("Ticket Expired", `This ticket was valid for ${data.billing.pickupDate}.`);
                return;
            }
        }

        // Handle UI Transition
        if (isGameActive) {
            // If playing, show notification inside game
            const readyBadge = document.getElementById("gameTicketReady");
            if (readyBadge) readyBadge.style.display = "block";
        } else {
            // If not playing, simply remove loader
            removeLoader();
        }
    }

    function showErrorScreen(title, msg) {
        document.body.innerHTML = `
            <div style="height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; font-family:sans-serif; background:white; position:fixed; top:0; left:0; width:100%; z-index:30000;">
                <img src="./assets/gotogo final logos/g2g fleet.png" alt="GoToGo Logo" style="width:100px; margin-bottom: 20px;" />
                <h1 style="color:#d32f2f;">${title}</h1>
                <p style="padding: 0 20px;">${msg}</p>
                <a href="/airport-shuttle.html" style="margin-top:20px; text-decoration:none; background:#eebd36; color:black; padding:10px 20px; border-radius:50px; font-weight:bold;">Go to Home</a>
            </div>
        `;
    }

    function renderTicketData(data) {
        // ... (‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§π‡•Ä ‡§≤‡•â‡§ú‡§ø‡§ï, ‡§∏‡•á‡§Æ ‡§ï‡•ã‡§°)
        document.getElementById("ticket-number").innerText = data.ticketNumber || "G2G-UNKNOWN";
        const pDate = data.billing ? data.billing.pickupDate : data.pickupDate;
        const formattedDate = new Date(pDate).toLocaleDateString("en-US", { year: "numeric", month: "long", day: "numeric" });
        document.getElementById("pickupDate").innerText = formattedDate;
        document.getElementById("pickupLocation").innerText = (data.billing ? data.billing.pickupLocation : data.pickupLocation) || "N/A";
        const pStatusDiv = document.getElementById("paymentStatus");
        if (pStatusDiv) {
            const method = data.paymentMethod ? data.paymentMethod.toLowerCase() : (data.paymentStatus === "success" ? "online" : "cash");
            pStatusDiv.innerText = method === "cash" ? "Pay on Arrival" : "Paid Online";
            pStatusDiv.style.color = method === "cash" ? "#e67e22" : "#27ae60";
        }
        const passengerList = document.getElementById("passengerList");
        if (passengerList) {
            passengerList.innerHTML = "";
            const namesArray = data.travelers ? data.travelers.map(t => t.name) : (data.names || []);
            namesArray.forEach(name => {
                if (name && name.trim()) {
                    const li = document.createElement("li");
                    li.textContent = name.trim();
                    passengerList.appendChild(li);
                }
            });
        }
        const bTime = data.billing ? data.billing.boardingTime : data.boardingTime;
        const dTerm = data.billing ? data.billing.terminal : data.terminal;
        document.querySelectorAll(".boarding-box").forEach(box => {
            box.classList.toggle("highlight", box.getAttribute("data-time") === bTime);
        });
        document.querySelectorAll(".terminal-box").forEach(box => {
            box.classList.toggle("highlight", box.getAttribute("data-terminal") === dTerm);
        });
    }

    // ==========================================
    // üöÄ MAIN EXECUTION
    // ==========================================
    document.addEventListener("DOMContentLoaded", async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const ticketId = urlParams.get('ticket');

        if (ticketId) {
            // CASE A: DB Fetch
            showFullPageLoader();
            
            // üõë TESTING: 10 ‡§∏‡•á‡§ï‡§Ç‡§° ‡§ï‡§æ ‡§°‡§ø‡§≤‡•á (‡§§‡§æ‡§ï‡§ø ‡§ó‡•á‡§Æ ‡§ü‡•á‡§∏‡•ç‡§ü ‡§ï‡§∞ ‡§∏‡§ï‡•á‡§Ç)
            // await new Promise(resolve => setTimeout(resolve, 10000)); 

            try {
                const response = await fetch(`https://paymentgatewayforairportshuttle.onrender.com/api/get-shuttle-ticket/${ticketId}`);
                const data = await response.json();

                if (data.success) {
                    onTicketLoaded(data.booking, true); // True = from DB
                } else {
                    if(isGameActive) closeGame();
                    removeLoader();
                    showErrorScreen("Invalid Ticket", "No such ticket found in our database.");
                }
            } catch (err) {
                if(isGameActive) closeGame();
                removeLoader();
                showErrorScreen("Connection Error", "Unable to connect to the server.");
            }
        } else {
            // CASE B: Local Storage
            const localData = JSON.parse(localStorage.getItem("bookingDetails"));
            if (!localData) {
                document.getElementById('mainContentWrapper').style.display = 'none';
                document.getElementById('noBookingModal').style.display = 'flex';
            } else {
                onTicketLoaded({
                    ticketNumber: localData.ticketNumber,
                    paymentMethod: localData.paymentStatus === "success" ? "online" : "cash",
                    billing: {
                        pickupDate: localData.pickupDate,
                        pickupLocation: localData.pickupLocation,
                        boardingTime: localData.boardingTime,
                        terminal: localData.terminal
                    },
                    travelers: localData.names.map(name => ({ name }))
                }, false);
            }
        }
    });
</script>
  </body>
</html>